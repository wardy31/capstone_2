{"ast":null,"code":"import { __awaiter, __extends, __generator } from \"tslib\";\nimport * as tf from '@tensorflow/tfjs-core';\nimport { Rect } from '../classes';\nimport { FaceDetection } from '../classes/FaceDetection';\nimport { toNetInput } from '../dom';\nimport { NeuralNetwork } from '../NeuralNetwork';\nimport { extractParams } from './extractParams';\nimport { extractParamsFromWeigthMap } from './extractParamsFromWeigthMap';\nimport { mobileNetV1 } from './mobileNetV1';\nimport { nonMaxSuppression } from './nonMaxSuppression';\nimport { outputLayer } from './outputLayer';\nimport { predictionLayer } from './predictionLayer';\nimport { SsdMobilenetv1Options } from './SsdMobilenetv1Options';\nvar SsdMobilenetv1 = /** @class */function (_super) {\n  __extends(SsdMobilenetv1, _super);\n  function SsdMobilenetv1() {\n    return _super.call(this, 'SsdMobilenetv1') || this;\n  }\n  SsdMobilenetv1.prototype.forwardInput = function (input) {\n    var params = this.params;\n    if (!params) {\n      throw new Error('SsdMobilenetv1 - load model before inference');\n    }\n    return tf.tidy(function () {\n      var batchTensor = input.toBatchTensor(512, false).toFloat();\n      var x = tf.sub(tf.mul(batchTensor, tf.scalar(0.007843137718737125)), tf.scalar(1));\n      var features = mobileNetV1(x, params.mobilenetv1);\n      var _a = predictionLayer(features.out, features.conv11, params.prediction_layer),\n        boxPredictions = _a.boxPredictions,\n        classPredictions = _a.classPredictions;\n      return outputLayer(boxPredictions, classPredictions, params.output_layer);\n    });\n  };\n  SsdMobilenetv1.prototype.forward = function (input) {\n    return __awaiter(this, void 0, void 0, function () {\n      var _a;\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            _a = this.forwardInput;\n            return [4 /*yield*/, toNetInput(input)];\n          case 1:\n            return [2 /*return*/, _a.apply(this, [_b.sent()])];\n        }\n      });\n    });\n  };\n  SsdMobilenetv1.prototype.locateFaces = function (input, options) {\n    if (options === void 0) {\n      options = {};\n    }\n    return __awaiter(this, void 0, void 0, function () {\n      var _a, maxResults, minConfidence, netInput, _b, _boxes, _scores, boxes, scores, i, scoresData, _c, _d, iouThreshold, indices, reshapedDims, inputSize, padX, padY, boxesData, results;\n      return __generator(this, function (_e) {\n        switch (_e.label) {\n          case 0:\n            _a = new SsdMobilenetv1Options(options), maxResults = _a.maxResults, minConfidence = _a.minConfidence;\n            return [4 /*yield*/, toNetInput(input)];\n          case 1:\n            netInput = _e.sent();\n            _b = this.forwardInput(netInput), _boxes = _b.boxes, _scores = _b.scores;\n            boxes = _boxes[0];\n            scores = _scores[0];\n            for (i = 1; i < _boxes.length; i++) {\n              _boxes[i].dispose();\n              _scores[i].dispose();\n            }\n            _d = (_c = Array).from;\n            return [4 /*yield*/, scores.data()];\n          case 2:\n            scoresData = _d.apply(_c, [_e.sent()]);\n            iouThreshold = 0.5;\n            indices = nonMaxSuppression(boxes, scoresData, maxResults, iouThreshold, minConfidence);\n            reshapedDims = netInput.getReshapedInputDimensions(0);\n            inputSize = netInput.inputSize;\n            padX = inputSize / reshapedDims.width;\n            padY = inputSize / reshapedDims.height;\n            boxesData = boxes.arraySync();\n            results = indices.map(function (idx) {\n              var _a = [Math.max(0, boxesData[idx][0]), Math.min(1.0, boxesData[idx][2])].map(function (val) {\n                  return val * padY;\n                }),\n                top = _a[0],\n                bottom = _a[1];\n              var _b = [Math.max(0, boxesData[idx][1]), Math.min(1.0, boxesData[idx][3])].map(function (val) {\n                  return val * padX;\n                }),\n                left = _b[0],\n                right = _b[1];\n              return new FaceDetection(scoresData[idx], new Rect(left, top, right - left, bottom - top), {\n                height: netInput.getInputHeight(0),\n                width: netInput.getInputWidth(0)\n              });\n            });\n            boxes.dispose();\n            scores.dispose();\n            return [2 /*return*/, results];\n        }\n      });\n    });\n  };\n  SsdMobilenetv1.prototype.getDefaultModelName = function () {\n    return 'ssd_mobilenetv1_model';\n  };\n  SsdMobilenetv1.prototype.extractParamsFromWeigthMap = function (weightMap) {\n    return extractParamsFromWeigthMap(weightMap);\n  };\n  SsdMobilenetv1.prototype.extractParams = function (weights) {\n    return extractParams(weights);\n  };\n  return SsdMobilenetv1;\n}(NeuralNetwork);\nexport { SsdMobilenetv1 };","map":{"version":3,"mappings":"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","names":["tf","Rect","FaceDetection","toNetInput","NeuralNetwork","extractParams","extractParamsFromWeigthMap","mobileNetV1","nonMaxSuppression","outputLayer","predictionLayer","SsdMobilenetv1Options","__extends","_super","SsdMobilenetv1","input","params","Error","tidy","batchTensor","toBatchTensor","toFloat","x","sub","mul","scalar","features","mobilenetv1","boxPredictions","classPredictions","output_layer","_a","forwardInput","_b","options","maxResults","minConfidence","netInput","_e","_boxes","_scores","boxes","scores","i","length","dispose","_d","from","data","scoresData","iouThreshold","indices","reshapedDims","getReshapedInputDimensions","inputSize","padX","width","padY","height","boxesData","arraySync","results","map","top","bottom","left","right","idx","getInputHeight","getInputWidth","weightMap","weights"],"sourceRoot":"","sources":["../../../src/ssdMobilenetv1/SsdMobilenetv1.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module","externalDependencies":[]}